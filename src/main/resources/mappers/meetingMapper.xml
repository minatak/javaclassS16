<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.javaclassS16.dao.MeetingDAO">
    
	<select id="getMeetingList" resultType="com.spring.javaclassS16.vo.FamilyMeetingVO">
	  SELECT * FROM familyMeeting
	  WHERE familyCode = #{familyCode}
	  <if test="statusFilter != null and statusFilter != ''">
	    AND status = #{statusFilter}
	  </if>
	  <choose>
	    <when test="sortBy == 'date'">
	      ORDER BY meetingDate
	    </when>
	    <when test="sortBy == 'status'">
	      ORDER BY 
	        CASE status
	          WHEN '진행 중' THEN '1'
	          WHEN '예정' THEN '2'
	          WHEN '완료' THEN '3'
	          ELSE '4'
	        END
	    </when>
	    <otherwise>
	      ORDER BY createdAt DESC
	    </otherwise>
	  </choose>
	  LIMIT #{startIndexNo}, #{pageSize}
	</select>
	
	<select id="getTotalMeetingsCount" resultType="int">
  	SELECT COUNT(*) FROM familyMeeting WHERE familyCode = #{familyCode}
	</select>
	
	<select id="getCompletedMeetingsCount" resultType="int">
    SELECT COUNT(*) FROM familyMeeting WHERE familyCode = #{familyCode} AND status = '완료'
	</select>
	
	<select id="getUpcomingMeetingsCount" resultType="int">
    SELECT COUNT(*) FROM familyMeeting WHERE familyCode = #{familyCode} AND status = '예정'
	</select>
	
	<select id="getThisMonthMeetingsCount" resultType="int">
    SELECT COUNT(*) FROM familyMeeting 
    WHERE familyCode = #{familyCode} 
    AND YEAR(meetingDate) = YEAR(CURDATE()) 
    AND MONTH(meetingDate) = MONTH(CURDATE())
	</select>
	
	<select id="getMeetingContent" resultType="com.spring.javaclassS16.vo.FamilyMeetingVO">
    SELECT * FROM familyMeeting WHERE familyCode = #{familyCode} AND idx = #{idx}
	</select>
	
	<select id="getMeetingTopics" resultType="com.spring.javaclassS16.vo.MeetingTopicVO">
    SELECT mt.* FROM meetingTopic mt
    JOIN meetingTopicLink mtl ON mt.idx = mtl.topicIdx
    WHERE mtl.meetingIdx = #{meetingIdx}
    ORDER BY mtl.discussionOrder
	</select>
	
	<select id="getUpcomingMeetings" resultType="com.spring.javaclassS16.vo.FamilyMeetingVO">
    SELECT * FROM familyMeeting 
    WHERE meetingDate > NOW() 
    AND familyCode = #{familyCode}
    ORDER BY meetingDate ASC 
    LIMIT 3
  </select>
	
	<select id="getProposedTopics" resultType="com.spring.javaclassS16.vo.MeetingTopicVO">
    SELECT t.*, COUNT(r.idx) as replyCnt
    FROM meetingTopic t
    LEFT JOIN meetingTopicReply r ON t.idx = r.topicIdx
    WHERE t.familyCode = #{familyCode}
    <if test="status != null and status != 'all'">
        AND t.status = #{status}
    </if>
    GROUP BY t.idx
    ORDER BY 
        CASE t.status
            WHEN '제안됨' THEN 1
            WHEN '승인됨' THEN 2
            WHEN '예정' THEN 3
            WHEN '논의중' THEN 4
            WHEN '결정됨' THEN 5
            WHEN '보류' THEN 6
            ELSE 7
        END,
        t.createdAt DESC
	</select>
	
	<select id="getTopicReplies" resultType="com.spring.javaclassS16.vo.MeetingTopicReplyVO">
    SELECT * FROM meetingTopicReply
    WHERE topicIdx = #{idx}
    ORDER BY createdAt ASC
  </select>
  
  <select id="getTopicByIdx" resultType="com.spring.javaclassS16.vo.MeetingTopicVO">
    SELECT * FROM meetingTopic WHERE idx = #{idx}
	</select>
	
	
	
	<insert id="setTopicInput" parameterType="com.spring.javaclassS16.vo.MeetingTopicVO">
    INSERT INTO meetingTopic (familyCode, title, description, priority, memberIdx, memberName)
    VALUES (#{topicVO.familyCode}, #{topicVO.title}, #{topicVO.description}, #{topicVO.priority}, #{topicVO.memberIdx}, #{topicVO.memberName})
	</insert>
	
	<insert id="setMeetingInput" parameterType="com.spring.javaclassS16.vo.FamilyMeetingVO" useGeneratedKeys="true" keyProperty="idx">
    INSERT INTO familyMeeting (familyCode, title, description, meetingDate, facilitatorIdx, facilitatorName, recorderIdx, recorderName, createdBy)
    VALUES (#{familyCode}, #{title}, #{description}, #{meetingDate}, #{facilitatorIdx}, #{facilitatorName}, #{recorderIdx}, #{recorderName}, #{createdBy})
  </insert>
  
  <insert id="linkTopicToMeeting">
    INSERT INTO meetingTopicLink (meetingIdx, topicIdx)
    VALUES (#{meetingIdx}, #{topicIdx})
  </insert>
  
  <insert id="insertNewTopic" parameterType="String" useGeneratedKeys="true" keyProperty="idx">
    INSERT INTO meetingTopic (familyCode, title, memberIdx, status)
    VALUES (#{familyCode}, #{newTopic}, #{createdBy}, '제안됨')
  </insert>
  
  <insert id="setReplyInput" parameterType="com.spring.javaclassS16.vo.MeetingTopicReplyVO">
    INSERT INTO meetingTopicReply (topicIdx, memberIdx, memberName, content)
    VALUES (#{topicIdx}, #{memberIdx}, #{memberName}, #{content})
	</insert>
  
  
	
	<update id="setMeetingMinutes" parameterType="com.spring.javaclassS16.vo.FamilyMeetingVO">
    UPDATE familyMeeting
    SET status = '완료', decisions = #{familyMeetingVO.decisions}, actionItems = #{familyMeetingVO.actionItems}, notes = #{familyMeetingVO.notes}
    WHERE idx = #{familyMeetingVO.idx} AND familyCode = #{familyMeetingVO.familyCode}
	</update>
	
	<update id="setTopicUpdate" parameterType="com.spring.javaclassS16.vo.MeetingTopicVO">
    UPDATE meetingTopic
    SET title = #{title}, description = #{description}, priority = #{priority}
    WHERE idx = #{idx}
	</update>
	
	
	
	<delete id="setReplyDelete" parameterType="int">
    DELETE FROM meetingTopicReply WHERE idx = #{idx}
	</delete>

	<delete id="setTopicDelete" parameterType="int">
    DELETE FROM meetingTopic WHERE idx = #{idx}
	</delete>

</mapper>